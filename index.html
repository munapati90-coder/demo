<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spice Garden ‚Äî Reserve Your Table</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap"
    rel="stylesheet" />
</head>

<body>

  <!-- TOAST CONTAINER -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- SESSION GUARD -->
  <script>
    var SESSION_KEY = "sg_session";
    var s = sessionStorage.getItem(SESSION_KEY);
    if (s !== "user" && s !== "admin") { window.location.replace("login.html"); }

    // Mode Logic
    const params = new URLSearchParams(window.location.search);
    const MODE = params.get('mode') || 'both'; // both, table, food
    document.documentElement.setAttribute('data-mode', MODE);
  </script>

  <!-- NAVIGATION -->
  <nav>
    <a href="choice.html" class="nav-brand">
      Spice Garden
      <span>Fine Indian Cuisine</span>
    </a>
    <ul class="nav-links">
      <li><a href="choice.html" class="nav-link">‚Üê Back</a></li>
      <li><a href="menu.html" class="nav-link">Menu</a></li>
      <li><a href="#" onclick="openHistory()" class="nav-link">My History</a></li>
      <li id="adminLink" style="display:none"><a href="admin.html" class="nav-link text-gold">Admin</a></li>
      <li id="navUserName"
        style="font-size:0.78rem;color:var(--gold-dark);font-weight:600;padding:0.3rem 0.8rem;background:rgba(200,134,10,0.08);border-radius:50px;border:1px solid rgba(200,134,10,0.15);">
      </li>
      <li><button onclick="logout()" class="btn btn-secondary"
          style="padding:0.4rem 1rem;font-size:0.8rem;">Logout</button></li>
    </ul>
  </nav>

  <!-- HERO -->
  <header class="hero" style="padding:2rem 1rem 1.5rem;">
    <span class="badge" id="heroBadge">‚ú¶ Online Reservation ‚ú¶</span>
    <h1 id="heroTitle" style="font-size:2rem;margin-bottom:0.5rem;">Experience the <em>Extraordinary</em></h1>
    <p id="heroText" style="max-width:480px;font-size:0.88rem;">Reserve your table and enjoy authentic flavors in a
      modern, elegant setting.</p>
  </header>

  <!-- BOOKING SECTION -->
  <div class="container section">
    <div class="booking-layout">

      <!-- LEFT PANEL: Table Map + Menu (always 1 grid child) -->
      <div class="left-panel">

        <!-- TABLE MAP -->
        <div id="tableSection">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.6rem;">
            <h3 class="text-gold" style="margin:0;font-size:1.1rem;">ü™ë Select a Table</h3>
            <div style="display:flex;gap:0.8rem;font-size:0.75rem;color:var(--text-muted);">
              <span style="display:flex;align-items:center;gap:4px;"><span
                  style="width:8px;height:8px;background:rgba(255,255,255,0.8);border:1px solid #fff;border-radius:50%;display:inline-block;box-shadow:var(--shadow-sm);"></span>Free</span>
              <span style="display:flex;align-items:center;gap:4px;"><span
                  style="width:8px;height:8px;background:var(--gold);border-radius:50%;display:inline-block;box-shadow:var(--shadow-sm);"></span>Selected</span>
              <span style="display:flex;align-items:center;gap:4px;"><span
                  style="width:8px;height:8px;background:#fca5a5;border-radius:50%;display:inline-block;box-shadow:var(--shadow-sm);"></span>Booked</span>
            </div>
          </div>
          <p class="text-muted" style="margin-bottom:0.8rem;font-size:0.82rem;">Click any available table to select it
            (2-hour slot).</p>
          <div class="table-grid" id="tableGrid">
            <div class="table-node" style="padding:2rem;grid-column:1/-1;color:var(--text-muted);">Loading...</div>
          </div>
        </div>

        <!-- FOOD MENU -->
        <div id="menuSection" style="display:none;">
          <h3 class="text-gold" style="margin-bottom:0.3rem;font-size:1.1rem;">üçΩÔ∏è Select Your Dishes</h3>
          <p class="text-muted" style="margin-bottom:0.5rem;font-size:0.82rem;">Pick items for your order. Cart updates
            in real-time.</p>
          <div id="guestMenusContainer"
            style="max-height:calc(100vh - 260px);overflow-y:auto;padding-right:6px;display:flex;flex-direction:column;gap:0;">
          </div>
        </div>

      </div><!-- /left-panel -->

      <!-- RIGHT: BOOKING FORM -->
      <div class="card form-card">

        <!-- Form Header -->
        <div style="margin-bottom:1.2rem;border-bottom:1px solid rgba(0,0,0,0.06);padding-bottom:0.8rem;">
          <h3 id="formTitle" style="margin:0 0 0.2rem;font-size:1.1rem;">Reservation Details</h3>
          <p id="formSubtitle" class="text-muted" style="margin:0;font-size:0.8rem;">Fill in the details to confirm your
            booking.</p>
        </div>

        <form onsubmit="return false;">

          <!-- Selected Table Display (table + both modes) -->
          <div class="form-group" id="tableSelectionGroup" style="margin-bottom:0.8rem;">
            <div id="selectedTableDisplay"
              style="display:flex;align-items:center;gap:8px;padding:0.65rem 0.9rem;background:rgba(255,255,255,0.5);border-radius:var(--radius-md);border:1px dashed var(--gold-light);color:var(--gold-dark);font-weight:700;font-size:0.85rem;">
              <span>ü™ë</span><span>No table selected yet</span>
            </div>
          </div>

          <!-- Name -->
          <div class="form-group" style="margin-bottom:0.75rem;">
            <label class="form-label" style="font-size:0.78rem;">üë§ Full Name *</label>
            <input type="text" id="guestName" class="form-input" placeholder="Your full name" />
          </div>

          <!-- Phone + Email -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:0.75rem;">
            <div>
              <label class="form-label" style="font-size:0.78rem;">üì± Mobile *</label>
              <input type="tel" id="guestPhone" class="form-input" placeholder="+91 xxxxx" />
            </div>
            <div>
              <label class="form-label" style="font-size:0.78rem;">üìß Email</label>
              <input type="email" id="email" class="form-input" placeholder="Optional" />
            </div>
          </div>

          <!-- Date + Time -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:0.75rem;">
            <div>
              <label class="form-label" style="font-size:0.78rem;">üìÖ Date *</label>
              <input type="date" id="dateInput" class="form-input" style="padding:0.65rem;"
                onchange="fetchAvailability()" />
            </div>
            <div>
              <label class="form-label" style="font-size:0.78rem;">üïê Time Slot *</label>
              <select id="timeInput" class="form-select" style="padding:0.65rem;" onchange="renderTables()">
                <option value="">Select Slot...</option>
                <option>12:00 PM - 02:00 PM</option>
                <option>02:00 PM - 04:00 PM</option>
                <option>05:00 PM - 07:00 PM</option>
                <option>07:00 PM - 09:00 PM</option>
                <option>09:00 PM - 11:00 PM</option>
              </select>
            </div>
          </div>

          <!-- Guests (hidden in food only) -->
          <div class="form-group" id="guestsGroup" style="margin-bottom:0.75rem;">
            <label class="form-label" style="font-size:0.78rem;">üë• No. of Guests *</label>
            <select id="guests" class="form-select">
              <option value="1">1 Person</option>
              <option value="2">2 People</option>
              <option value="3">3 People</option>
              <option value="4">4 People</option>
              <option value="5">5 People</option>
              <option value="6">6 People</option>
              <option value="8">8 People</option>
              <option value="10">10 People</option>
            </select>
          </div>

          <!-- Special Requests -->
          <div class="form-group" style="margin-bottom:1rem;">
            <label class="form-label" style="font-size:0.78rem;">üìù Special Requests</label>
            <textarea id="special" class="form-input" rows="2"
              placeholder="Dietary notes, seating preferences..."></textarea>
          </div>

          <!-- Submit -->
          <button onclick="submitBooking()" id="submitBtn" class="btn btn-primary" style="width:100%;">
            ‚úî Confirm Booking
          </button>

        </form>
      </div><!-- /form-card -->

    </div>
  </div>

  <!-- FLOATING CART BUTTON -->
  <button id="cartToggle" class="cart-toggle-btn" onclick="toggleCart()">
    üõí <span id="cartCountBadge" class="cart-badge">0</span>
  </button>

  <!-- CART DRAWER -->
  <div id="cartDrawer" class="cart-drawer">
    <div class="cart-header">
      <h4>üõí Your Order</h4>
      <button onclick="toggleCart()" class="btn-close">√ó</button>
    </div>
    <div id="cartItemsList" class="cart-body">
      <p class="text-muted" style="text-align:center;padding:2rem;">Your cart is empty.</p>
    </div>
    <div class="cart-footer">
      <div class="cart-total">Total: <strong><span id="cartTotalDisplay">‚Çπ0</span></strong></div>
      <button onclick="toggleCart()" class="btn btn-primary" style="width:100%;margin-top:0.5rem;">Close Cart</button>
    </div>
  </div>

  <!-- SUCCESS MODAL -->
  <div class="modal-backdrop" id="successModal">
    <div class="modal-content" style="text-align:center;">
      <div style="font-size:3.5rem;margin-bottom:0.8rem;">üéâ</div>
      <h2 class="text-gold" style="margin-bottom:0.5rem;">Booking Confirmed!</h2>
      <p class="text-muted" style="font-size:0.88rem;">Your reservation has been secured successfully.</p>
      <div id="modalRef"
        style="background:var(--gold-soft);border:1px solid var(--gold);padding:0.8rem 1.2rem;border-radius:var(--radius-md);font-weight:800;margin:1.5rem 0;color:var(--gold-dark);letter-spacing:2px;font-family:monospace;font-size:1.1rem;box-shadow:inset 0 2px 4px rgba(255,255,255,0.8);">
        SG-XXXX</div>
      <button onclick="closeSuccess()" class="btn btn-primary" style="padding:0.75rem 2.5rem;">Done ‚úî</button>
    </div>
  </div>

  <!-- HISTORY MODAL -->
  <div class="modal-backdrop" id="historyModal">
    <div class="modal-content" style="text-align:left;max-width:580px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem;">
        <h3 class="text-gold" style="margin:0;">üìã My Booking History</h3>
        <button onclick="closeHistory()"
          style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-muted);line-height:1;">√ó</button>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:1.2rem;">
        <input type="tel" id="histMobile" class="form-input" placeholder="Enter Mobile Number to search..." />
        <button onclick="fetchHistory()" class="btn btn-primary" style="white-space:nowrap;">Search</button>
      </div>
      <div id="histList" style="max-height:320px;overflow-y:auto;padding-right:4px;">
        <p class="text-muted" style="text-align:center;padding:1rem;">Enter your mobile number above.</p>
      </div>
    </div>
  </div>

  <!-- JAVASCRIPT -->
  <script>
    /* CONFIG & STATE */
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbyFpeajjPkn7-mu6pdTd3dfzHTKelL2Fx73ZyPgrYxfUiuYGm-sgm0EdMzHlKq48bUPDw/exec";

    // Static Tables Data
    const TABLES = [
      { id: 1, name: "Table 1", cap: 2, icon: "ü™ë" }, { id: 2, name: "Table 2", cap: 2, icon: "ü™ë" },
      { id: 3, name: "Table 3", cap: 4, icon: "üçΩÔ∏è" }, { id: 4, name: "Table 4", cap: 4, icon: "üçΩÔ∏è" },
      { id: 5, name: "Table 5", cap: 4, icon: "üçΩÔ∏è" }, { id: 6, name: "Table 6", cap: 6, icon: "üé™" },
      { id: 7, name: "Table 7", cap: 6, icon: "üé™" }, { id: 8, name: "Table 8", cap: 8, icon: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶" },
      { id: 9, name: "Table 9", cap: 8, icon: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶" }, { id: 10, name: "Table 10", cap: 10, icon: "üéä" }
    ];

    // Full Menu Data (matches menu.html)
    const MENU = [
      // Starters
      { id: "s1", name: "Samosa (2 pcs)", desc: "Crispy pastry filled with spiced potato & peas", price: 120, icon: "ü•ü", cat: "starters", veg: true },
      { id: "s2", name: "Paneer Tikka", desc: "Smoky marinated cottage cheese off the tandoor", price: 280, icon: "üßÄ", cat: "starters", veg: true },
      { id: "s3", name: "Chicken 65", desc: "Crispy deep-fried spiced chicken", price: 320, icon: "üçó", cat: "starters", veg: false },
      { id: "s4", name: "Tandoori Prawns", desc: "Juicy prawns marinated in tandoori masala", price: 480, icon: "ü¶ê", cat: "starters", veg: false },
      { id: "s5", name: "Veg Spring Rolls", desc: "Crunchy rolls with mixed veggie filling", price: 180, icon: "üåØ", cat: "starters", veg: true },
      { id: "s6", name: "Seekh Kebab", desc: "Minced lamb kebabs grilled on skewers", price: 360, icon: "üçñ", cat: "starters", veg: false },
      // Mains
      { id: "m1", name: "Butter Chicken", desc: "Classic creamy tomato-cashew gravy", price: 380, icon: "üçó", cat: "mains", veg: false },
      { id: "m2", name: "Paneer Tikka Masala", desc: "Chargrilled paneer in rich masala sauce", price: 320, icon: "üçõ", cat: "mains", veg: true },
      { id: "m3", name: "Dal Makhani", desc: "Slow-cooked black lentils, butter & cream", price: 240, icon: "ü´ò", cat: "mains", veg: true },
      { id: "m4", name: "Chicken Biryani", desc: "Fragrant basmati rice with tender chicken", price: 420, icon: "üçö", cat: "mains", veg: false },
      { id: "m5", name: "Veg Biryani", desc: "Aromatic rice with garden vegetables", price: 340, icon: "üçö", cat: "mains", veg: true },
      { id: "m6", name: "Mutton Rogan Josh", desc: "Kashmiri-style slow-cooked lamb curry", price: 520, icon: "ü•©", cat: "mains", veg: false },
      { id: "m7", name: "Fish Curry", desc: "Fresh fish in a tangy coconut-tamarind gravy", price: 460, icon: "üêü", cat: "mains", veg: false },
      { id: "m8", name: "Chana Masala", desc: "Chickpeas in bold spiced tomato gravy", price: 220, icon: "üå±", cat: "mains", veg: true },
      { id: "m9", name: "Palak Paneer", desc: "Cottage cheese in smooth spinach sauce", price: 280, icon: "ü•¨", cat: "mains", veg: true },
      { id: "m10", name: "Mixed Veg Curry", desc: "Seasonal vegetables in fragrant sauce", price: 200, icon: "ü•¶", cat: "mains", veg: true },
      // Breads & Rice
      { id: "b1", name: "Butter Naan", desc: "Soft tandoor-baked bread with butter", price: 70, icon: "ü´ì", cat: "breads", veg: true },
      { id: "b2", name: "Garlic Naan", desc: "Naan topped with fresh garlic & herbs", price: 80, icon: "ü´ì", cat: "breads", veg: true },
      { id: "b3", name: "Tandoori Roti", desc: "Whole-wheat bread from the tandoor", price: 50, icon: "ü´ì", cat: "breads", veg: true },
      { id: "b4", name: "Paratha", desc: "Flaky whole-wheat bread, pan-fried", price: 70, icon: "ü´ì", cat: "breads", veg: true },
      { id: "b5", name: "Jeera Rice", desc: "Basmati rice tempered with cumin", price: 150, icon: "üçö", cat: "breads", veg: true },
      { id: "b6", name: "Plain Rice", desc: "Steamed long-grain basmati rice", price: 120, icon: "üçö", cat: "breads", veg: true },
      // Desserts
      { id: "d1", name: "Gulab Jamun (2 pcs)", desc: "Soft milk-solid dumplings in rose syrup", price: 120, icon: "üçÆ", cat: "desserts", veg: true },
      { id: "d2", name: "Rasmalai", desc: "Chilled cottage cheese pats in saffron milk", price: 150, icon: "üßÅ", cat: "desserts", veg: true },
      { id: "d3", name: "Kheer", desc: "Creamy rice pudding with cardamom & nuts", price: 130, icon: "üç®", cat: "desserts", veg: true },
      { id: "d4", name: "Kulfi", desc: "Traditional Indian ice cream ‚Äî mango or pistachio", price: 110, icon: "üç¶", cat: "desserts", veg: true },
      { id: "d5", name: "Gajar Halwa", desc: "Warm carrot pudding with ghee & nuts", price: 140, icon: "ü•ï", cat: "desserts", veg: true },
      // Drinks
      { id: "dr1", name: "Mango Lassi", desc: "Chilled sweet yoghurt & mango drink", price: 120, icon: "ü•≠", cat: "drinks", veg: true },
      { id: "dr2", name: "Masala Chai", desc: "Spiced Indian milk tea", price: 70, icon: "‚òï", cat: "drinks", veg: true },
      { id: "dr3", name: "Fresh Lime Soda", desc: "Fizzy lime soda ‚Äî sweet or salty", price: 90, icon: "üçã", cat: "drinks", veg: true },
      { id: "dr4", name: "Jal Jeera", desc: "Cumin-infused sparkling drink", price: 80, icon: "ü•§", cat: "drinks", veg: true },
      { id: "dr5", name: "Bottled Water", desc: "Chilled mineral water (500ml)", price: 40, icon: "üíß", cat: "drinks", veg: true },
      { id: "dr6", name: "Rose Sharbat", desc: "Chilled rose syrup & milk drink", price: 100, icon: "üåπ", cat: "drinks", veg: true },
    ];

    let selectedTableId = null;
    let dailyBookings = [];
    let cart = {}; // itemId -> quantity

    /* INIT */
    window.onload = () => {
      // Admin Check
      if (sessionStorage.getItem(SESSION_KEY) === "admin") {
        document.getElementById("adminLink").style.display = "block";
      }

      // Pre-fill name & phone from login session
      const savedName = sessionStorage.getItem("sg_name");
      const savedMobile = sessionStorage.getItem("sg_mobile");
      if (savedName && document.getElementById("guestName")) document.getElementById("guestName").value = savedName;
      if (savedMobile && document.getElementById("guestPhone")) document.getElementById("guestPhone").value = savedMobile;

      // Show user name in nav
      const navName = document.getElementById("navUserName");
      if (navName && savedName) navName.textContent = "üë§ " + savedName;

      // 1. Mode-specific UI text & visibility
      const heroTitle = document.getElementById('heroTitle');
      const heroText = document.getElementById('heroText');
      const heroBadge = document.getElementById('heroBadge');
      const formTitle = document.getElementById('formTitle');
      const formSubtitle = document.getElementById('formSubtitle');

      if (MODE === "food") {
        document.getElementById("tableSection").style.display = "none";
        document.getElementById("menuSection").style.display = "block";
        document.getElementById("tableSelectionGroup").style.display = "none";

        heroTitle.innerHTML = "Savor the <em>Exquisite</em>";
        heroText.textContent = "Order from our award-winning menu. Fresh, fast, and full of flavor.";
        heroBadge.textContent = "‚ú¶ Quick Food Ordering ‚ú¶";
        formTitle.textContent = "Order Details";
        formSubtitle.textContent = "Fill in your details and we'll get your food ready.";

      } else if (MODE === "table") {
        document.getElementById("tableSection").style.display = "block";
        document.getElementById("menuSection").style.display = "none";

        heroTitle.innerHTML = "Reserve Your <em>Perfect Spot</em>";
        heroText.textContent = "From intimate dinners to grand celebrations ‚Äî book your table in seconds.";
        heroBadge.textContent = "‚ú¶ Table Reservation ‚ú¶";
        formTitle.textContent = "Booking Details";
        formSubtitle.textContent = "Secure your table for an unforgettable evening.";

      } else {
        document.getElementById("tableSection").style.display = "block";
        document.getElementById("menuSection").style.display = "block";

        heroTitle.innerHTML = "The <em>Complete</em> Experience";
        heroText.textContent = "Choose your table and pre-order your favourite dishes for a seamless evening.";
        heroBadge.textContent = "‚ú¶ Table + Food Booking ‚ú¶";
        formTitle.textContent = "Full Reservation";
        formSubtitle.textContent = "Coordinate your table and meal perfectly.";
      }

      // 2. Set Date Restrictions
      const now = new Date();
      const offset = now.getTimezoneOffset() * 60000;
      const localDate = new Date(now - offset).toISOString().split("T")[0];
      document.getElementById("dateInput").min = localDate;
      document.getElementById("dateInput").value = localDate;

      renderMenu();
      if (MODE !== "food") fetchAvailability();
    };

    /* ------ RENDER FUNCTIONS ------ */
    function renderTables() {
      const userTime = document.getElementById("timeInput").value;
      const grid = document.getElementById("tableGrid");
      if (!grid) return;
      grid.innerHTML = "";

      const busyIds = [];
      if (userTime) {
        const uMin = timeToMin(userTime);
        dailyBookings.forEach(b => {
          const bMin = timeToMin(b["Time"]);
          if (Math.abs(uMin - bMin) < 120 && b["Status"] !== "Cancelled") {
            busyIds.push(parseInt(b["Table ID"]));
          }
        });
      }

      TABLES.forEach(t => {
        const isBooked = busyIds.includes(t.id);
        const isSelected = selectedTableId === t.id;
        let cls = "table-node";
        if (isBooked) cls += " booked";
        if (isSelected) cls += " selected";

        const div = document.createElement("div");
        div.className = cls;
        div.onclick = () => selectTable(t.id, isBooked);
        div.innerHTML = `
          <span class="t-icon">${t.icon}</span>
          <div class="t-name">${t.name}</div>
          <div class="t-cap">Up to ${t.cap} guests</div>
          <div class="t-status">${isBooked ? "Taken" : isSelected ? "Selected" : "Free"}</div>
        `;
        grid.appendChild(div);
      });
    }

    let menuFilter = "all";

    function renderMenu() {
      const container = document.getElementById("guestMenusContainer");
      if (!container) return;

      const catTabs = [
        { key: "all", label: "‚ú® All" },
        { key: "starters", label: "ü•ü Starters" },
        { key: "mains", label: "üçõ Mains" },
        { key: "breads", label: "ü´ì Breads" },
        { key: "desserts", label: "üçÆ Desserts" },
        { key: "drinks", label: "‚òï Drinks" }
      ];

      const items = menuFilter === "all" ? MENU : MENU.filter(m => m.cat === menuFilter);

      const tabsHtml = catTabs.map(c => `
        <button onclick="setMenuFilter('${c.key}')"
          style="padding:5px 12px;border-radius:50px;border:1px solid var(--glass-border);
                 background:${menuFilter === c.key ? 'var(--gold-gradient)' : 'rgba(255,255,255,0.8)'};
                 color:${menuFilter === c.key ? 'white' : 'var(--text-muted)'};
                 font-size:0.75rem;font-weight:700;cursor:pointer;transition:var(--trans-fast);white-space:nowrap;
                 box-shadow:${menuFilter === c.key ? 'var(--shadow-gold)' : 'var(--shadow-sm)'};">
          ${c.label}
        </button>`).join("");

      const cardsHtml = items.map(m => {
        const qty = cart[m.id] || 0;
        return `
          <div style="background:var(--bg-glass-strong);border-radius:var(--radius-lg);padding:1rem;
                      border:1px solid ${qty > 0 ? 'var(--gold)' : 'var(--glass-border)'};
                      transition:var(--trans-base);display:flex;flex-direction:column;
                      box-shadow:${qty > 0 ? 'var(--shadow-gold)' : 'var(--shadow-sm)'}; backdrop-filter:blur(12px);">
            <div style="font-size:2rem;margin-bottom:0.35rem;">${m.icon}</div>
            <div style="display:flex;justify-content:space-between;align-items:start;gap:4px;margin-bottom:0.2rem;">
              <h4 style="font-size:0.8rem;margin:0;font-weight:700;line-height:1.3;">${m.name}</h4>
              <span style="font-weight:800;color:var(--gold-dark);font-size:0.78rem;white-space:nowrap;">‚Çπ${m.price}</span>
            </div>
            <p style="font-size:0.7rem;color:var(--text-muted);flex-grow:1;margin-bottom:0.45rem;line-height:1.4;">${m.desc}</p>
            <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid rgba(0,0,0,0.05);padding-top:0.45rem;">
              <span style="font-size:0.62rem;font-weight:700;padding:2px 5px;border-radius:4px;
                ${m.veg ? 'color:#166534;background:#DCFCE7;' : 'color:#991B1B;background:#FEE2E2;'}">
                ${m.veg ? 'üü¢ VEG' : 'üî¥ NON'}
              </span>
              <div style="display:flex;align-items:center;gap:4px;">
                <button class="btn-qty" style="width:22px;height:22px;font-size:0.85rem;" onclick="updateCart('${m.id}', -1)">‚àí</button>
                <span style="min-width:16px;text-align:center;font-size:0.82rem;font-weight:700;${qty > 0 ? 'color:var(--gold-dark);' : ''}">${qty}</span>
                <button class="btn-qty" style="width:22px;height:22px;font-size:0.85rem;" onclick="updateCart('${m.id}', 1)">+</button>
              </div>
            </div>
          </div>`;
      }).join("");

      container.innerHTML = `
        <div style="display:flex;gap:0.35rem;flex-wrap:wrap;margin-bottom:0.7rem;">${tabsHtml}</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:0.7rem;">${cardsHtml}</div>
      `;
    }

    function setMenuFilter(cat) {
      menuFilter = cat;
      renderMenu();
    }




    /* ------ CART LOGIC ------ */
    function updateCart(id, delta) {
      const current = cart[id] || 0;
      const next = current + delta;
      if (next <= 0) delete cart[id];
      else cart[id] = next;

      renderMenu();
      updateCartUI();
    }

    function updateCartUI() {
      const totalItems = Object.values(cart).reduce((a, b) => a + b, 0);
      document.getElementById("cartCountBadge").textContent = totalItems;

      const list = document.getElementById("cartItemsList");
      let totalValue = 0;

      const itemsHtml = Object.keys(cart).map(id => {
        const item = MENU.find(x => x.id === id);
        totalValue += item.price * cart[id];
        return `
          <div class="cart-item-row">
            <div class="cart-item-info">
                <h5>${item.name}</h5>
                <p>‚Çπ${item.price} √ó ${cart[id]}</p>
            </div>
            <div style="font-weight:700;">‚Çπ${item.price * cart[id]}</div>
          </div>
        `;
      }).join("");

      list.innerHTML = itemsHtml || '<p class="text-muted" style="text-align:center; padding:2rem;">Your cart is empty.</p>';
      document.getElementById("cartTotalDisplay").textContent = "‚Çπ" + totalValue;
    }

    function toggleCart() {
      document.getElementById("cartDrawer").classList.toggle("show");
    }

    /* ------ BOOKING LOGIC ------ */
    function selectTable(id, isBooked) {
      if (isBooked) return showToast("Table Occupied", "This table is already booked.", "error");
      const t = document.getElementById("timeInput").value;
      if (!t) return showToast("Check Slot", "Please select a Time Slot first.", "warning");

      selectedTableId = (selectedTableId === id) ? null : id;
      renderTables();

      // Update the form display box
      const display = document.getElementById("selectedTableDisplay");
      if (display) {
        if (selectedTableId) {
          const tObj = TABLES.find(x => x.id === selectedTableId);
          display.innerHTML = `<span>ü™ë</span><span style="color:var(--gold-dark);font-weight:700;">${tObj.name} selected ‚Äî up to ${tObj.cap} guests ‚úî</span>`;
          display.style.borderColor = "var(--gold)";
          display.style.background = "var(--gold-soft)";
        } else {
          display.innerHTML = `<span>ü™ë</span><span>No table selected yet</span>`;
          display.style.borderColor = "var(--gold-light)";
          display.style.background = "rgba(255,255,255,0.5)";
        }
      }
    }

    function fetchAvailability() {
      const date = document.getElementById("dateInput").value;
      fetch(`${SHEET_URL}?action=today&date=${date}`)
        .then(r => r.json())
        .then(d => {
          dailyBookings = d.bookings || [];
          renderTables();
        })
        .catch(e => showToast("Error", "Could not check availability.", "error"));
    }

    function submitBooking() {
      // 1. STRICT Validation based on mode
      const isTableMode = (MODE === "table" || MODE === "both");
      const isFoodMode = (MODE === "food" || MODE === "both");

      if (isTableMode && !selectedTableId) {
        return showToast("Select Table", "Please click a table on the map to proceed.", "error");
      }

      const cartTotalItems = Object.values(cart).reduce((a, b) => a + b, 0);
      if (isFoodMode && cartTotalItems === 0) {
        return showToast("Cart Empty", "Please add at least one item to your order.", "error");
      }

      const name = document.getElementById("guestName").value.trim();
      const phone = document.getElementById("guestPhone").value.trim();
      const date = document.getElementById("dateInput").value;
      const time = document.getElementById("timeInput").value;

      if (!name || !phone || !date || !time) return showToast("Missing Info", "Fill all required fields (*)", "error");

      const btn = document.getElementById("submitBtn");
      btn.disabled = true;
      btn.textContent = "Confirming...";

      const menuSummary = Object.keys(cart).map(id => {
        const item = MENU.find(x => x.id === id);
        return `${item.name} (x${cart[id]})`;
      }).join(", ");

      const payload = {
        ref: "SG-" + Math.random().toString(36).substr(2, 6).toUpperCase(),
        emp_no: phone, // Use phone as unique identifier
        name: name,
        phone: phone,
        email: document.getElementById("email").value,
        date: date,
        time: time,
        guests: isTableMode ? document.getElementById("guests").value : "N/A",
        table: isTableMode ? TABLES.find(x => x.id === selectedTableId).name : "N/A (Food Only)",
        table_id: isTableMode ? selectedTableId : 0,
        special: document.getElementById("special").value,
        status: "Confirmed",
        type: MODE.toUpperCase(),
        menu: isFoodMode ? (menuSummary || "No items") : "Table Only (No Food)"
      };

      fetch(SHEET_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      })
        .then(r => r.json())
        .then(d => {
          btn.disabled = false;
          btn.textContent = "Confirm Booking";
          if (d.success) {
            document.getElementById("modalRef").textContent = payload.ref;
            document.getElementById("successModal").classList.add("show");
            // Reset
            cart = {};
            selectedTableId = null;
            updateCartUI();
            renderMenu();
            if (MODE !== "food") fetchAvailability();
          } else showToast("Error", d.error, "error");
        })
        .catch(() => {
          btn.disabled = false;
          btn.textContent = "Confirm Booking";
          showToast("Error", "Network issue.", "error");
        });
    }

    // Helper: Time-to-Min
    function timeToMin(str) {
      if (!str) return -1;
      let [t, mod] = str.split(' ');
      let [h, m] = t.split(':');
      if (h === '12') h = '00';
      if (mod === 'PM') h = parseInt(h) + 12;
      return parseInt(h) * 60 + parseInt(m);
    }

    /* ------ UI HELPERS ------ */
    function showToast(title, msg, type = "success") {
      const c = document.getElementById("toastContainer");
      const t = document.createElement("div");
      t.className = `toast ${type}`;
      t.innerHTML = `<div class="toast-content"><h4>${title}</h4><p>${msg}</p></div>`;
      c.appendChild(t);
      setTimeout(() => t.classList.add("show"), 10);
      setTimeout(() => { t.classList.remove("show"); setTimeout(() => t.remove(), 400); }, 3000);
    }
    function closeSuccess() { window.location.href = "choice.html"; }
    function logout() {
      sessionStorage.removeItem("sg_session");
      sessionStorage.removeItem("sg_name");
      sessionStorage.removeItem("sg_mobile");
      window.location.href = "login.html";
    }
    function openHistory() {
      const mobile = sessionStorage.getItem("sg_mobile") || "";
      const input = document.getElementById("histMobile");
      if (input) input.value = mobile;
      document.getElementById("historyModal").classList.add("show");
      if (mobile) fetchHistory();
    }
    function closeHistory() { document.getElementById("historyModal").classList.remove("show"); }


    function fetchHistory() {
      const mobile = document.getElementById("histMobile").value.trim();
      if (!mobile) return showToast("Required", "Please enter your Mobile Number", "warning");

      const list = document.getElementById("histList");
      list.innerHTML = `<p style="text-align:center;padding:1rem;">Searching...</p>`;

      fetch(`${SHEET_URL}?action=history&phone=${encodeURIComponent(mobile)}`)
        .then(r => r.json())
        .then(res => {
          if (!res.success || !res.bookings.length) {
            list.innerHTML = `<p style="text-align:center;padding:1rem;color:var(--danger);">No bookings found.</p>`;
            return;
          }

          list.innerHTML = res.bookings.map(b => {
            const type = (b["Booking Type"] || "BOTH").toUpperCase();
            const typeLabel = type === "TABLE" ? "ü™ë Table Only" : type === "FOOD" ? "ü•° Food Only" : "‚ú® Combined";
            const isConfirmed = b["Status"] === "Confirmed";

            return `
                    <div class="history-card" style="margin-bottom:1rem; padding:1.2rem; border-radius:var(--radius-md); border:1px solid var(--glass-border); background:rgba(255,255,255,0.85); backdrop-filter:blur(12px); box-shadow:var(--shadow-sm);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem; align-items:center;">
                            <span style="font-size:0.75rem; font-weight:800; color:var(--gold-dark);">${b["Booking Ref"]}</span>
                            <span class="h-status ${b["Status"] === 'Cancelled' ? 'st-cancelled' : 'st-confirmed'}">${b["Status"]}</span>
                        </div>
                        <div style="font-weight:700; margin-bottom:0.3rem;">${b["Date"]} | ${b["Time"]}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:0.8rem;">${typeLabel}</div>
                        ${b["Guest Orders"] ? `<div style="font-size:0.75rem; padding:8px; background:#f9fafb; border-radius:8px;">${b["Guest Orders"]}</div>` : ''}
                    </div>
                    `;
          }).join("");
        })
        .catch(() => {
          list.innerHTML = `<p style="text-align:center;padding:1rem;color:var(--danger);">Error fetching history.</p>`;
        });
    }
  </script>
</body>

</html>